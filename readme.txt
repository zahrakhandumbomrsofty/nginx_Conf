please use the openresty because i have used the nginx with lua support  . if you can't install openresty then you have to 
compile the nginx with lua support 


Also i tried the whole thing with cookies 
you can try the whole thing with username and the password 
and can use the map functionality instead of the lua blocks .